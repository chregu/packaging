# This Makefile has been generated by the packaging/configure script. DO NOT
# modify it manually. If you want to modify the Makefile model, modify the
# packaging/Makefile.in file
NAME=@PACKAGENAME@
VERSION=@VERSION@
MAINTAINER=@MAINTAINER@
PACKAGENAME=@PACKAGENAME@
PACKAGETYPE=@PACKAGETYPE@
URL=@URL@
ARCH=all
DEPENDS=@DEPENDS@
EXCLUDE=@EXCLUDE@
MAINTAINER=@MAINTAINER@
DESCRIPTION=@DESCRIPTION@
POSTINST=@POSTINST@
PREINST=@PREINST@
POSTRM=@POSTRM@
PRERM=@PRERM@
TEMPLATEDIR=@TEMPLATEDIR@
TMP=@TMPDIR@
PTMP=$(TMP)/$(PACKAGENAME)
ifneq ($(POSTINST),)
POSTINSTCMD = --post-install $(PTMP)/misc/$(POSTINST)
else
POSTINSTCMD=
endif
ifneq ($(PREINST),)
PREINSTCMD = --pre-install $(PTMP)/misc/$(PREINST)
else
PREINSTCMD=
endif
ifneq ($(POSTRM),)
POSTRMCMD = --post-uninstall $(PTMP)/misc/$(POSTRM)
else
POSTRMCMD=
endif
ifneq ($(PRERM),)
PRERMCMD = --pre-uninstall $(PTMP)/misc/$(PRERM)
else
PRERMCMD=
endif

all: package

clean:
	rm -rf $(PTMP)

structure: clean
	mkdir -p $(PTMP)/src $(PTMP)/build $(PTMP)/misc
	rsync -r --exclude packaging --exclude Makefile \
		--exclude packaging_config.php --exclude '.git*' --exclude '.svn' \
		--exclude '.CVS' --exclude "$(TMP)" $(EXCLUDE) . $(PTMP)/src
ifneq ($(POSTINST),)
	tar -C $(PTMP)/src/ -cf - $(POSTINST) | (cd $(PTMP)/misc; tar -xf - )
	rm -r $(PTMP)/src/$(POSTINST)
endif

ifneq ($(PREINST),)
	tar -C $(PTMP)/src/ -cf - $(PREINST) | (cd $(PTMP)/misc; tar -xf - )
	rm -r $(PTMP)/src/$(PREINST)
endif

ifneq ($(POSTRM),)
	tar -C $(PTMP)/src/ -cf - $(POSTRM) | (cd $(PTMP)/misc; tar -xf - )
	rm -r $(PTMP)/src/$(POSTRM)
endif

ifneq ($(PRERM),)
	tar -C $(PTMP)/src/ -cf - $(PRERM) | (cd $(PTMP)/misc; tar -xf - )
	rm -r $(PTMP)/src/$(PRERM)
endif

template: structure
	./packaging/template $(PTMP)/src/$(TEMPLATEDIR)

build: template
	@INSTALLCMD@

package: build
	fpm -s dir -t $(PACKAGETYPE) -n "$(PACKAGENAME)" -v "$(VERSION)" -m "$(MAINTAINER)" --url "$(URL)" \
		--description "$(DESCRIPTION)" $(DEPENDS) $(POSTINSTCMD) $(PREINSTCMD) $(POSTRMCMD) $(PRERMCMD) \
		-a $(ARCH) -C $(PTMP)/build -p $(PTMP)/$(PACKAGENAME)_$(VERSION).$(PACKAGETYPE)

